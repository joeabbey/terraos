# Local filesystem mounting			-*- shell-script -*-

#
# This script overrides local_mount_root() in /scripts/local
# and mounts root as a read-only filesystem with a temporary (rw)
# overlay filesystem.
#

. /scripts/local

rescue_shell() {
    busybox --install -s
    exec /bin/sh
}

local_mount_root()
{
	local_top
	local_device_setup "${ROOT}" "root file system"
	ROOT="${DEV}"

	# Get the root filesystem type if not set
	if [ -z "${ROOTFSTYPE}" ]; then
		FSTYPE=$(get_fstype "${ROOT}")
	else
		FSTYPE=${ROOTFSTYPE}
	fi

	local_premount

	# CHANGES TO THE ORIGINAL FUNCTION BEGIN HERE
	# N.B. this code still lacks error checking

	modprobe ${FSTYPE}
	checkfs ${ROOT} root "${FSTYPE}"

	# Create directories for root and the overlay

	mkdir -p /sd
	# mount the disk to sd
	if [ "${FSTYPE}" != "unknown" ]; then
		mount -t ${FSTYPE} ${ROOTFLAGS} ${ROOT} /sd
	else
		mount ${ROOTFLAGS} ${ROOT} /sd
	fi
	# create persistent dir for containerd snapshotts
	mkdir -p /sd/vl

	OPTS="$(cat /sd/odisk)"
	# Mount the final overlay-root in $rootmnt
	mount -t overlay -o "${OPTS}" overlay ${rootmnt} || rescue_shell
	# overlay the ext4 on /var/lib so containerd to create overlay dirs
	mount --bind /sd/vl ${rootmnt}/var/lib || rescue_shell
}
