# Local filesystem mounting			-*- shell-script -*-

#
# This script overrides local_mount_root() in /scripts/local
#

. /scripts/local

rescue_shell() {
    busybox --install -s
    exec /bin/sh
}

local_mount_root()
{
	local_top
	local_device_setup "${ROOT}" "root file system"

	ROOT="${DEV}"
	VHOST="${vhost}"
	local_premount

	# CHANGES TO THE ORIGINAL FUNCTION BEGIN HERE
	# N.B. this code still lacks error checking

	echo "setting up squashfs..."

	modprobe squashfs
	modprobe unionfs

	# mount the iso
	mkdir -p /run/iso /fs
	mount -t iso9660 /dev/sr0 /run/iso

	mount -t squashfs -o loop /run/iso/live.sq ${rootmnt}
	mount -t tmpfs tmpfs ${rootmnt}/tmp
}
