# Local filesystem mounting			-*- shell-script -*-

#
# This script overrides local_mount_root() in /scripts/local
# and mounts root as a read-only filesystem with a temporary (rw)
# overlay filesystem.
#

. /scripts/local

rescue_shell() {
    busybox --install -s
    exec /bin/sh
}

local_mount_root()
{
	local_top
	local_device_setup "${ROOT}" "root file system"
	ROOT="${DEV}"
	DISK_LABEL="${disk_label}"
	VERSION=${version}
	9P_SERVER="${9p_server}"
	9P_MOUNT="${9p_mount}"

	if [ -z "${DISK_LABEL}" ]; then
		DISK_LABEL="os"
	fi

	# find the disk with the terra label
	if [ -z "${ROOT}" ]; then
		ROOT=$(blkid -L "${DISK_LABEL}")
	fi

	# Get the root filesystem type if not set
	if [ -z "${ROOTFSTYPE}" ]; then
		FSTYPE=$(get_fstype "${ROOT}")
	else
		FSTYPE=${ROOTFSTYPE}
	fi

	local_premount

	modprobe ${FSTYPE}
	checkfs ${ROOT} root "${FSTYPE}"

	mkdir /lower
	mount -t ${FSTYPE} ${ROOTFLAGS} ${ROOT} /lower || rescue_shell
	if [ -z "${VERSION}" ]; then
		VERSION="os"
	fi

	mount -o subvol=/${VERSION} -t btrfs ${ROOT} ${rootmnt} || rescue_shell
	mount -t 9p -o "version=9p2000.L,uname=root,access=user,aname=${9P_MOUNT}" ${9P_SERVER} ${rootmnt}/etc || rescue_shell
}
